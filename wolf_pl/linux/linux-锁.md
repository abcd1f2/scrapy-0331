## linux - 锁
- **概述：**
>       32位IA-32处理器使用基于对缓存加锁或者总线加锁的方式来实现多处理器之间的原子操作。
>       总线锁：
>           总线锁就是使用处理提供的一个LOCK信号，当一个处理器在总线上输出此信号，其他处理器的请求将给阻塞住，那么该处理器可以独占使用共享内存。
>       缓存锁：
>           由于总线锁把CPU和内存之间通信锁住了，这使得锁住期间，其他处理器不能操作其他内存地址的数据，所以总线锁的开销较大。！！！
>           最新的处理器在某些场合下使用缓存锁替代总线索进行优化。！！！优化
>           频繁使用的内存会缓存在处理器的L1、L2和L3高速缓存中
>           缓存一致性机制会阻止同时修改被两个以上处理器缓存的内存区域数据，当其他处理器回写已被锁定的缓存行的数据时，会引起缓存行无效。如当CPU1修改缓存行中的n变量使用缓存锁定，那么CPU2就不能同时缓存n的缓存行
>       处理器保证从系统内存中读取或者写入一个字节是原子的，即当一个处理器读取一个字节时，其他处理器不能访问这个字节的内存地址。
>
>
>
>
>
>
>

- **锁原理：**
>       硬件层面：CPU提供了原子操作、关中断、锁内存总线的机制
>       操作系统：OS基于这几个CPU硬件机制，能够实现锁
>       用户空间：基于锁，实现各种同步机制（信号量、消息、Barrier等）
>
>       所有的同步操作最基础的理论就是原子操作。内存屏障、锁都是为了保证在不同平台或者是CPU类型下的原子操作。
>       原子操作在单核、单线程、无中断，且编译器不优化的情况下是确定的，是按照代码顺序执行的，所以不存在异步的问题。
>

- **自己实现互斥锁：**
>       见下图：
>![avatar](https://github.com/nwaiting/wolf-ai/blob/master/wolf_others/pic/linux_lock.jpg)
>
>       自己实现互斥锁需要使用到汇编指令和lock锁汇编指令：
>           void mylock(int *lock) {
>               int tmp = 1;
>               while (tmp == 1) {
>                   tmp = *lock; // 如果 *lock 为 1，说明锁被占用，这时候会死循环。
>                   *lock = 1; // 无论锁有没有被占用，这里都将共享内存的值置 1.
>               }
>           }
>       为了实现多个线程同时调用，那么必须让tmp=*lock;*lock=1;两条命令原子执行，C语言中不能实现，那么只能通过汇编指令实现-xchg。
>       在多核CPU中，为了防止竞争，只要在汇编指令前加一条前缀lock即可。这样可以防止一条汇编指令被多个CPU同时执行。！！！！！！！！
>       void mylock(int *lock) {
>           __asm__ __volatile__ (...);
>       }
>       asm：表示在c语言中内联汇编
>       volatile：同多线程操作时候的可变变量申明
>

- **如何避免死锁：**
>       使用互斥锁，应当尽量避免同时获得多个锁，且遵循以下原则：
>           1、线程在需要多个锁时，都按相同的先后顺序获得锁
>           2、尽量使用pthread_mutex_trylock替代pthread_mutex_lock调用
>           3、为了解决死锁的问题，需要引入更多的线程互斥与同步机制，如条件变量等
>

- **linux互斥锁的实现：**
>       struct mutex {
>           atomic_t  count; //引用计数器,1: 锁可以利用,小于等于0：该锁已被获取，需要等待
>           spinlock_t  wait_lock;//自旋锁类型，保证多cpu下，对等待队列访问是安全的。
>           spinlock_t  wait_lock; //等待队列，如果该锁被获取，任务将挂在此队列上，等待调度。
>           struct list_head wait_list;
>       };
>

- **待续：**
>       参考：https://blog.csdn.net/q1007729991/article/details/61426006
>       https://www.jianshu.com/p/a7ddb2998b3b
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
