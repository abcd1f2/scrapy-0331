### webRTC的交互流程
- **概述：**
>
>
>
>
>
>

- **拉流流程：**
>       订阅拉流会话建立流程：
>           1、A创建一个PeerConnection对象，然后打开本地的音视频设备，将音视频数据封装到MediaStream添加到PeerConnection中
>           2、A调用PeerConnection的CreateOffer创建一个offer的sdp对象，sdp中保存当前音视频相关参数 ！！！！
>           3、A调用SetLocalDescription将sdp保存
>           4、A通过信令将sdp发送给B
>           5、B接收到A的offer SDP对象，通过PeerConnection的SetRemoteDescription保存起来
>           6、B调用PeerConnection的CreateAnswer创建一个应答的SDP
>           7、B调用SetLocalDescription保存answer SDP对象
>           8、B通过信令机制将自己的SDP发送给A
>           9、A调用PeerConnection对象的SetRemoteDescription保存B的SDP
>           10、在SDP信息的offer/answer流程中，A和B已经根据SDP创建好相应的音频Channel和视频Channel，
>               并开启Candidate数据的手机，Candidate可以理解成client端的IP地址信息（本地IP地址、公网IP地址、Relay服务端分配的地址）
>           11、A收集自己的Candidate，PeerConnection通过OnIceCandidate接口给A发送通知
>           12、A将本地的Candidate信息通过信令机制发送给B
>           13、B通过PeerConnection的AddIceCandidate方法将A的Candidate保存起来
>           14、B收集自己的Candidate信息，PeerConnection通过OnIceCandidate接口给B发送通知
>           15、B将收集到Candidate信息通过信令发送给A
>           16、A通过PeerConnection的AddIceCandidate方法将B的Candidate保存起来
>
>           总结：
>           A -> off -> B -> answer -> A
>           A -> OnIceCandidate -> A -> B(AddIceCandidate) -> OnIceCandidate -> B -> A(AddIceCandidate)
>

- **推流流程：**
>       推流流程：
>           client : publish
>           (worker : init)//信令目前无效 （CreateOffer）
>           client : offer
>           worker : answer （SetRemoteSdp，工程中包含candidate信息）
>           client : candidate
>           worker : ready
>
>

- **生成SDP（SessionDescription Protocol）过程：**
>       1、PeerConnectionInterface::CreateOffer()生成的Offer SDP会异步通知给Conductor::OnSuccess()  ！！！！
>       2、被叫生成的Answer SDP会从Conductor::OnMessageFromPeer传过来，然后通过PeerConnectionInterface::SetRemoteDescription接口设置
>       3、被叫调用PeerConnectionInterface的对应接口以及顺序和主叫有一定区别，具体为：SetRemoteDescription()->CreateAnswer()->SetLocalDescription()。
>       4、对于主叫，SetLocalDescription()参数是Offer SDP，SetRemoteDescription()参数为Answer SDP
>       5、对于被叫，SetLocalDescription()参数是Answer SDP，SetRemoteDescription()参数是Offer SDP
>       6、webRTC通常用常量来区分Offer SDP和Answer SDP：
>           const char SessionDescriptionInterface::kOffer[] = "offer";
>           const char SessionDescriptionInterface::kPrAnswer[] = "pranswer";
>           const char SessionDescriptionInterface::kAnswer[] = "answer";
>       7、如果是回环测试(loopback)，PeerConnectionInterface的相关接口调用以及顺序没有区别，只是不需要通过PeerConnectionClient，由服务器转发
>       8、只有PeerConnectionInterface的SetLocalDescription()以及SetRemoteDescription()接口被正确调用后，才可以设置IceCandidate
>

- **处理IceCandidate：**
>       1、ICE全称是Interacte Connectivity Establishment。也是由IETF定义的一套标准协议。
>           它提供了一套标准的框架方法用于解决两点间的通信，并且优先选择点对点的通信方式；如果无法建立点对点通信业可以通过服务器转发。
>       2、ICE框架基本原理：
>           对每一种可能的连接方式定义优先级，并逐个尝试，尝试连接成功且优先级最高的方式就是最后被选择的通信方式。
>       3、ICE使用STUN(Session Traversal Utilities for NAT)协议用于网络地址转换(NAT,NetWork Address Translation)
>           使用TURN(Traversal Using Relay NAT)协议用于消息转发
>           webRTC连接ICE Server（STUN或TURN）是为了测试出自己的NAT类型
>           TURN Server包含了STUN Server的功能而且包含了Relay中转功能
>       4、一个IceCandidate可以是一个（IP地址+端口号+优先级）的组合，WebRTC会尝试ping每一个对方发过来的IceCandidate，从中选择可以ping通的优先级最大的IceCandidate用于交换媒体数据
>       5、流程：
>           WebRTC收集本地的IceCandidate，收到的IceCandidate会异步通知Conductor::OnIceCandidate()函数，然后直接发送给对方。
>           对方接收到IceCandidate后调用PeerConnectionInterface::AddIceCandidate()接口尝试连接它
>       6、当ICE的连接状态发生改变时会调用Conductor::OnIceConnectionChange()。ICE连接状态在枚举中：enum IceConnectionState {};
>       7、webRTC将媒体数据抽象为webrtc::MediaStreamInterface对象，可以通过Conductor::OnAddStream()回调获得Stream中包含的VideoTrack来渲染视频数据
>
>
>
>

- **小结：**
>       1、无论主叫还是被叫，通信成功需要的参数：LocalSDP、RemoteSDP、Remote IceCandidate
>       2、对应上面的PeerConnectionInterface的接口：SetLocalDescription()、SetRemoteDescription()、AddIceCandidate()
>       3、获取LocalSDP和Local IceCandidate回调：Conductor::OnSuccess()、Conductor::OnIceCandidate()
>       4、通过OnSuccess()获取SDP后，可以修改默认参数，如：视频编码器从VP8改为H264
>       5、Conductor::OnIceConnectionChange()通知的状态与信令服务器的连接状态(PeerConnectionServer)无关
>       6、流中添加或者删除音视频通道：
>           stream->AddTrack(video_track);  //注释后就没有视频流
>
>
>
>
>
>

- **待续：**
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
