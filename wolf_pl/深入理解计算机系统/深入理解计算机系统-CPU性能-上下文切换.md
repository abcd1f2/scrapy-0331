## 深入理解计算机系统 - CPU性能 - 上下文切换
- **概述**
>
>       线程是调度的基本单元，进程是资源拥有的基本单元。
>       同属一个进程的线程，发生上下文切换，只切换线程的私有数据，共享数据不变，所以速度非常快。
>
>
>
>
>

- **上下文切换类型：**
>       1、进程上下文切换
>           进程运行态分为内核运行态（内核堆栈、寄存器等）和进程运行态（虚拟内存、栈、变量、正文、数据等）
>       2、线程上下文切换
>           不同的进程之间的线程上下文切换，过程和进程上下文切换大致相同
>           进程内部线程切换，只需要切换线程私有数据
>       3、中断上下文切换
>           如响应硬件的事件（USB接入），中断处理会打断进程的正常调度和执行
>           中断处理比进程拥有更高的优先级
>
>

- **触发上下文切换：**
>       1、系统调用
>           需要进行2次CPU上下文切换（用户空间 --> 内核空间 --> 用户空间）
>       2、进程状态转换(运行、就绪、阻塞)
>           进程是由内核来管理和调度的，进程的切换只能发生在内核态。进程的上下文不仅包括用户空间的资源，也包括内核空间资源
>       3、时间片耗尽
>       4、系统资源不足
>       5、sleep
>       6、优先级调度
>       7、硬件中断
>

- **进程上下文切换过程：**
>       1、收到切换信号，挂起进，记录当前进程的虚拟内存、栈等资源存储
>       2、将进程的CPU中的上下文状态存储起来
>       3、在内存中检索进程的上下文
>       4、将其加载到CPU的寄存器中恢复
>       5、刷新进程的虚拟内存和用户栈
>       6、最后跳转到程序计算器所指向的位置（即跳转到进程被中断时的代码行），恢复该进程
>
>

- **触发进程上下文切换场景：**
>       1、CPU时间片耗尽，系统的进程调度
>       2、资源不足，在获取到足够资源前进程挂起
>       3、进程sleep挂起进程
>       4、高优先级进程导致当前进程挂起
>       5、硬件中断，导致当前进程挂起
>

- **减少上下文切换的技术：**
>       1、数据库连接池
>       2、设置合理的最大进程、最大线程数
>       3、直接内存访问DMA
>       4、零拷贝技术
>
>

- **perf性能分析：**
>       https://www.cnblogs.com/happyliu/p/6142929.html     perf + 火焰图分析程序性能
>       https://jakearchibald.github.io/svgomg/     在线显示svg图片
>       perf record 和 perf report 分析占用CPU时钟最多的函数
>
>
>
>
>
>
>
>
>
>
>
>
>
>

- **待续：**
>       参考：
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
