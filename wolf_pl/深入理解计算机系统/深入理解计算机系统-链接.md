## 深入理解计算机系统 - 链接
- **概述**
>       目标文件纯粹是字节块的集合。这些块中，有些包含程序代码，有些包含程序数据，而其他的则包含引导链接器和加载器的数据结构。
>       链接器将这些块连接起来，确定被链接块的运行时位置，并且修改代码和数据块中的各种位置。链接器对目标机器了解甚少。产生目标文件的编译器和汇编器已经完成了大部分工作。
>
>
>

- **链接：**
>       早期计算机系统中，链接是手动执行的。在现代系统中，链接是由叫做链接器的程序自动执行的。
>
>       1、链接可以执行于编译时，也就是在源代码翻译成机器代码时
>       2、可以执行与加载时，也就是在程序被加载器加载到内存并执行时
>       3、可以执行于运行时，就是由应用程序来执行
>

- **学习链接器的目的：**
>       1、理解链接器将帮助你构造大型程序
>           常见的如缺少模块、缺少库或者不兼容的库版本引起的链接器错误
>       2、理解链接器将帮助你避免一些危险的编程错误
>           常见错误：在默认情况下，错误地定义多个全局变量的程序将通过链接器，而不产生任何警告信息。由此得到的程序会产生令人迷惑的运行时行为，非常难以调试。
>       3、理解链接将帮助你理解其他重要的系统概念。
>           链接器产生的可执行目标文件在重要的系统中扮演着关键角色，比如加载和运行程序、虚拟内存、分页、内存映射等
>       4、理解链接将使你能够利用共享库
>

- **编译链接过程：**
>       1、C预处理器(cpp)将源程序翻译长ASCII的中间文件.i
>       2、驱动程序运行C编译器(cc1)，将.i翻译成一个.s
>       3、驱动程序运行汇编器(as)，将.s翻译成一个可重定位目标文件.o
>       4、运行链接器程序ld，将.o以及一些必要的系统目标文件组合起来，创建一个可执行目标文件exe
>

- **加载过程：**
>       shell调用系统中一个叫做加载器(loader)的函数，它将可执行文件exe中的代码和数据复制到内存，然后将控制转移到这个程序的开头。
>
>

- **静态链接：**
>       为了构造可执行文件，链接器必须完成两个主要任务：
>           1、符号解析（符号应用与符号定义）
>               符号解析的目的是将每个符号引用正好和一个符号定义关联起来
>           2、重定位（符号定义与内存位置）
>               编译器和汇编器生成从地址0开始的代码和数据节。
>               链接器通过把每个符号定义与一个内存位置关联起来，从而重定位这些节，然后修改所有对这些符号的引用，使得它们指向这个内存位置。
>               链接器使用汇编器产生的重定位条目的详细指令，不加甄别地执行这样的重定位。
>

- **目标文件：**
>       目标文件有三种形式：
>           1、可重定位目标文件
>               包含二进制代码和数据，其形式可在编译时与其他可重定位目标文件合并起来，创建一个可执行目标文件。
>           2、可执行目标文件
>               包含二进制代码和数据，其形式可以被直接复制到内存中执行
>           3、共享目标文件
>               可以在加载或者运行时被动态地加载进内存并链接
>           编译器和汇编器生成可重定位目标文件（包括共享目标文件）。
>           链接器生成可执行目标文件。
>

- **可重定位目标文件：**
>       ELF(Execut-able and Linkable Format)格式如下：
>           1、ELF头以一个16字节的序列开始，描述该文件的系统和字的大小和字节顺序
>           2、ELF头剩下的部分包含帮助链接器语法分析和解释目标文件的信息。有以下信息：
>               a、ELF头的大小
>               b、目标文件的类型（如可重定位、可执行或者共享）
>               c、机器类型（如x86-64）
>               d、节头部表的文件偏移
>               e、节头部表中条目的大小和数量，不同节的位置和大小是由节头部表描述的，其中目标文件中每个节都有一个固定大小的条目
>
>           夹在ELF头和节头部表之间的都是节。一个典型的ELF可重定位目标文件包含下面几个节：
>               1、.text
>                   已编译程序的机器代码
>               2、.rodata
>                   只读数据，比如printf语句中的格式串和开关语句的跳转表
>               3、.data
>                   已初始化的全局和静态C变量。
>               4、.bss
>                   未初始化的全局和静态C变量，以及所有被初始化为0的全局或静态变量。
>                   在目标文件中，这个节不占据实际的空间，仅仅是一个占位符。
>                   目标文件格式区分已初始化和未初始化变量是为了空间效率。在目标文件中，不占用任何实际的磁盘空间，在运行时，在内存中分配这些变量，初始值为0。
>               5、.symtab
>                   符号表是由汇编器构造的，使用编译器输出到汇编语言.s文件中的符号。
>                   符号表中所包含的信息用于定位和重定位程序中的符号定义和引用。目标文件的其他部分通过一个符号在这个表中的索引值来使用该符号。！！！
>                   一个符号表，存放在程序中定义和引用的函数和全局变量的信息。.symtab节中包含ELF符号表。这张符号表包含一个条目的数组。！！！
>                   实际上每个可重定位目标文件在.symtab中都有一张符号表(除非特意用STRIP命令去掉它)。和编译器中的符号表不同，.symtab符号表不包含局部变量的条目。
>                   a、由于局部变量在栈中被管理，链接器对此类符号不感兴趣。
>                   b、定义带有C static属性的本地过程变量是不在栈中管理的。编译器在.data和.bss中为每个定义分配空间，并在符号表中创建一个有唯一名字的本地链接器符号。
>               6、.rel.text
>                   一个.text节中位置的列表，当链接器把这个目标文件和其他文件组合时，需要修改这些位置。
>                   一般而言，任何调用外部函数或者引用全局变量的指令都需要修改。另一方面，调用本地函数的指令则不需要修改。
>                   注意：
>                       可执行目标文件中并不需要重定位信息，因此通常省略，除非用户显示地指示链接器包含这些信息。
>               7、.rel.data
>                   被模块引用或定义的所有全局变量的重定位信息。
>                   一般而言，任何已初始化的全局变量，如果它的初始值是一个全局变量地址或者外部定义函数的地址，都需要被修改。
>               8、.debug
>                   一个调试符号表，其条目是程序中定义的局部变量和类型定义，程序中定义和应用的全局变量，以及原始的C源文件。
>                   只有以-g选项编译程序时，才会得到这张表。
>               9、.line
>                   原始C源程序中的行号和.text节中机器指令之间的映射。
>                   只有-g选项编译程序时，才会得到这张表。
>               10、.strtab
>                   一个字符串表，其内存包括.symtab和.debug节中的符号表，以及节头部中的节名字。
>                   字符串表都是以null结尾的字符串的序列
>

- **符号和符号表：**
>       每个可重定位目标模块m都有一个符号表，它包含m定义和引用的符号的信息。
>       有三种不同的符号：
>           1、由模块m定义并被其他模块引用的全局符号。
>               全局链接器符号对应于非静态的C函数和全局变量
>           2、由其他模块定义并被模块m引用的全局符号。
>               这些符号称为外部符号，对应于其他模块中定义的非静态C函数和全局变量。
>           3、只被模块m定义和引用的局部符号。
>               这些符号在模块m中任何位置都可见，但是不能被其他模块引用。
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>

- **待续：**
>       参考：
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
